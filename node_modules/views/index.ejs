<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="../../socket.io/socket.io.js"></script>
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/alertify.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/css/alertify.min.css"/>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/css/themes/default.min.css"/>
    
    <title>Node.js chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body { font: 13px Helvetica, Arial; background: black; height: 100%; display: flex; min-height: 100vh; flex-direction: column;}
        form { background: #fff; flex-shrink: none; padding: 3px; bottom: 0; width: 100%; border-color: #000; border-top-width: 1px; background:black;}
        form input { border-style: solid; border-width: 1px; padding: 10px; width: 85%; margin-right: .5%; color:#8cabd9; background:black;}
        #messages {
          list-style-type: none; 
          margin: 0; 
          padding: 0; 
          color: #8cabd9;
          flex: 1;
          }
        #messages li { 
          padding: 5px 10px;
          flex: 1 0 auto;
          }
        #send {  
                background-color: #8cabd9;
                color: white;
                padding: 12px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                width: 230px;
                margin-left: 0.9%;
        }
        #typing {
          color: #91C7A9;
        }
        #charCount {
          color: white;
        }
        .ajs-cancel {
          display: none;
        }
        /* .ajs-ok {
          
        } */
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <text id="typing"></text>
    <form action="/" method="POST" id="chatForm" class="sticky-bottom">
      <input id="txt" autocomplete="off" autofocus="on" maxlength="250" oninput="isTyping()" placeholder="Type your message here..." /><text id="charCount" disabled>250</text><button id="send" disabled>Send</button>
    </form>
    <script>
            var socket = io.connect('192.168.1.41:8080');

            socket.emit('join');

            // submit text message without reload/refresh the page
            $('form').submit(function(e){
                e.preventDefault(); // prevents page reloading
                var msg = escapeHtml($('#txt').val());
                if(!msg){
                  return false;
                }
                socket.emit('chat_message', msg);
                socket.emit('typing', "");
                $('#txt').val('');
                $('#send').prop('disabled', true);
                $('#charCount').text(250);
                $('#charCount').css('color', 'white');
                $('#charCount').css('font-weight', 'normal');
                return false;
            });
            // append the chat text message
            socket.on('chat_message', function(msg){
                $('#messages').append($('<li>').html(msg));
                window.scrollTo(0,document.body.scrollHeight);
            });
            // append text if someone is online
            socket.on('is_online', function(username) {
                $('#messages').append($('<li>').html(username));
            });
            socket.on('typing', function(hasText){
              $('#typing').html(hasText);
            });
            var entityMap = {
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#39;',
              '/': '&#x2F;',
              '`': '&#x60;',
              '=': '&#x3D;'
            };
            //sanitize inputs - should they be also sanitized in node? they show &lt and &gt too idk
            function escapeHtml (string) {
              return String(string).replace(/[&<>"'`=\/]/g, function (s) {
                return entityMap[s];
              });
            }

            //typing msg
            function isTyping(){
              $('#send').prop('disabled', false);
              if($('#txt').val()){
                socket.emit('typing', "emit");
              } else{
                socket.emit('typing', "");
              }
              window.scrollTo(0,document.body.scrollHeight);
              $('#charCount').text(250 - $('#txt').val().length);
              if($('#charCount').text() < 0){
                $('#charCount').text('0');
              }
              if($('#charCount').text()=='0'){
                $('#charCount').css('color', '#FA8072');
                $('#charCount').css('font-weight', 'bold');
              } else{
                $('#charCount').css('color', 'white');
                $('#charCount').css('font-weight', 'normal');
              }
            }
    </script>
  </body>
</html>