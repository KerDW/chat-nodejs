<!DOCTYPE html>
<html>
  <head>
    <title>Simple Group Chat on Node.js</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 13px Helvetica, Arial; background: black;}
        form { background: #fff; padding: 3px; position: fixed; bottom: 0; width: 100%; border-color: #000; border-top-style: solid; border-top-width: 1px; background:black;}
        form input { border-style: solid; border-width: 1px; padding: 10px; width: 85%; margin-right: .5%; color:#8cabd9; background:black;}
        form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; margin-left: 2%; }
        #messages { list-style-type: none; margin: 0; padding: 0; color: #8cabd9;}
        #messages li { padding: 5px 10px;}
        #send {  
                background-color: #8cabd9;
                color: white;
                padding: 12px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                width: 270px;
                margin-left: 0.5%;
        }
        #typing {
          color: #8cabd9;
        }
        #charCount {
          color: #8cabd9;
        }
        /* #upfile1 {
          height: 50px;
          width: 50px;
        } */
        /* #chatForm{
          box-sizing: border-box;
          background-color: none;
        } */
    </style>
    <script src="../../socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  </head>
  <body>
    <ul id="messages"></ul>
    <text id="typing"></text>
    <form action="/" method="POST" id="chatForm">
      <input id="txt" autocomplete="off" autofocus="on" maxlength="250" oninput="isTyping()" placeholder="Type your message here..." /><text id="charCount" disabled>250</text><button id="send" disabled>Send</button>
    </form>
    <script>
            var socket = io.connect('http://172.30.94.40:8080');
            // submit text message without reload/refresh the page
            $('form').submit(function(e){
                e.preventDefault(); // prevents page reloading
                var msg = escapeHtml($('#txt').val());
                if(!msg){
                  return false;
                }
                socket.emit('chat_message', msg);
                socket.emit('typing', "");
                $('#txt').val('');
                $('#send').prop('disabled', true);
                $('#charCount').text(250);
                $('#charCount').css('color', 'white');
                return false;
            });
            // append the chat text message
            socket.on('chat_message', function(msg){
                $('#messages').append($('<li>').html(msg));
                $('html, body').animate({scrollTop:$(document).height()}, 'fast');
            });
            // append text if someone is online
            socket.on('is_online', function(username) {
                $('#messages').append($('<li>').html(username));
            });
            socket.on('typing', function(hasText){
              $('#typing').html(hasText);
            });
            var entityMap = {
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#39;',
              '/': '&#x2F;',
              '`': '&#x60;',
              '=': '&#x3D;'
            };
            //sanitize inputs - should they be also sanitized in node? they show &lt and &gt too idk
            function escapeHtml (string) {
              return String(string).replace(/[&<>"'`=\/]/g, function (s) {
                return entityMap[s];
              });
            }
            // ask username
            promptName();
            function promptName(){
              var username = escapeHtml(prompt('Insert your username:'));
              socket.emit('username', username);
            }
            //typing msg
            function isTyping(){
              $('#send').prop('disabled', false);
              if($('#txt').val()){
                socket.emit('typing', "emit");
              } else{
                socket.emit('typing', "");
              }
              $('#charCount').text(250 - $('#txt').val().length);
              if($('#charCount').text() < 0){
                $('#charCount').text('0');
              }
              if($('#charCount').text()=='0'){
                $('#charCount').css('color', '#FA8072');
              } else{
                $('#charCount').css('color', 'white');
              }
            }
    </script>
  </body>
</html>